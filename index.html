<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BMW Service Locations — Vehicles Map</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }

    .controls{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:#fff; padding:8px 10px; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      max-width: calc(100vw - 24px);
    }
    .controls input{
      padding:6px 8px; border-radius:8px; border:1px solid #ddd;
      width: 360px; max-width: 70vw;
    }
    .controls button{
      padding:6px 10px; border-radius:8px; border:1px solid #ddd;
      cursor:pointer; background:#f6f6f6;
    }

    .legend{
      position:absolute; bottom:12px; left:12px; z-index:1000;
      background:#fff; padding:8px 10px; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
      font-size:13px; line-height:1.35;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      max-width: calc(100vw - 24px);
    }
    .count{ font-weight:700; }
    .small{ font-size:12px; opacity:.85; }
    .popup-title{ font-weight:800; font-size:16px; margin-bottom:6px; }
    .pill{
      display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid #ddd; background:#fafafa; margin-left:6px; white-space:nowrap;
    }
    .veh{ margin-top:8px; border-top:1px solid #eee; padding-top:8px; }
    .veh ul{ margin:6px 0 0 18px; padding:0; }
    .veh li{ margin:2px 0; }
    code{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="controls">
    <input id="search" type="text" placeholder="Search dealer / VIN / #12/67 / LHD / RHD…" />
    <button id="resetBtn" title="Reset view">Reset</button>
    <span id="shownCount"></span>
  </div>

  <div class="legend">
    <div><span class="count" id="totalLocs">0</span> locations loaded</div>
    <div><span class="count" id="totalVins">0</span> VIN rows loaded</div>
    <div><span class="count" id="skippedNoCoords">0</span> rows missing coords</div>
    <div><span class="count" id="skippedBadCoords">0</span> rows with bad coords</div>
    <div class="small">Data file: <code>vehicles.csv</code></div>
    <div class="small">Uses headers: VIN, LHD/RHD, Most Recent Servicing Dealer, Latitude and Longitude</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /**********************
     * CONFIG
     **********************/
    const VEHICLES_CSV = "vehicles.csv"; // must match your GitHub filename exactly

    /**********************
     * MAP
     **********************/
    const map = L.map('map', { zoomControl: true }).setView([50.6, 10.4], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markerLayer = L.layerGroup().addTo(map);
    const allMarkers = [];
    const bounds = L.latLngBounds([]);

    const searchInput = document.getElementById('search');
    const shownCount = document.getElementById('shownCount');
    const totalLocs = document.getElementById('totalLocs');
    const totalVins = document.getElementById('totalVins');
    const skippedNoCoordsEl = document.getElementById('skippedNoCoords');
    const skippedBadCoordsEl = document.getElementById('skippedBadCoords');

    const esc = (s) => String(s ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

    function parseCoords(val) {
      if (!val) return [NaN, NaN];

      // tolerate: "48.25, 11.62" or "(48.25,11.62)"
      const s = String(val).trim()
        .replace(/[()]/g, '')
        .replace(/\s+/g, '');

      const parts = s.split(',');
      if (parts.length < 2) return [NaN, NaN];

      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      return [lat, lng];
    }

    function normalizeCoordKey(lat, lng) {
      return `${lat.toFixed(6)},${lng.toFixed(6)}`;
    }

    function formatSpecial(raw) {
      const t = String(raw || '').trim();
      const m = t.match(/^#?(\d{1,3})\s*[-/ ]\s*(LHD|RHD)$/i);
      if (m) {
        const num = String(parseInt(m[1], 10)).padStart(2, '0');
        const side = m[2].toUpperCase();
        return `#${num}/67 ${side}`;
      }
      return t;
    }

    function addLocationMarker(lat, lng, locationName, items) {
      const count = items.length;
      const MAX = 60; // keep popup sane
      const list = items.slice(0, MAX);

      const popupHtml = `
        <div class="popup-title">${esc(locationName || 'Service Location')}</div>
        <div class="small"><b>Coords:</b> ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
        <div class="small"><b>Vehicles at this location:</b> ${count}${count > MAX ? ` (showing first ${MAX})` : ''}</div>
        <div class="veh">
          <ul>
            ${list.map(v => `
              <li>
                <code>${esc(v.vin)}</code>
                ${v.special ? `<span class="pill">${esc(v.special)}</span>` : ''}
              </li>
            `).join('')}
          </ul>
        </div>
      `;

      const m = L.circleMarker([lat, lng], {
        radius: Math.min(11, 4 + Math.ceil(count / 6)),
        weight: 1,
        opacity: 1,
        fillOpacity: 0.85
      }).bindPopup(popupHtml);

      m.meta = {
        location: (locationName || '').toLowerCase(),
        veh: items.map(v => `${v.vin} ${v.special}`).join(' ').toLowerCase(),
        count
      };

      allMarkers.push(m);
      bounds.extend([lat, lng]);
    }

    function renderMarkers() {
      markerLayer.clearLayers();
      const f = (searchInput.value || '').trim().toLowerCase();
      let visible = 0;

      for (const m of allMarkers) {
        const hit = !f || m.meta.location.includes(f) || m.meta.veh.includes(f);
        if (hit) { m.addTo(markerLayer); visible++; }
      }

      shownCount.textContent = `${visible} shown`;
      totalLocs.textContent = allMarkers.length;

      if (visible > 0) {
        try { map.fitBounds(markerLayer.getBounds().pad(0.2)); } catch {}
      }
    }

    /**********************
     * LOAD CSV (header-name based; works with leading blank column)
     **********************/
    Papa.parse(VEHICLES_CSV, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const rows = results.data || [];
        totalVins.textContent = rows.length;

        // Your header names (exact)
        const COL_VIN    = "VIN";
        const COL_SPEC   = "LHD/RHD";
        const COL_DEALER = "Most Recent Servicing Dealer";
        const COL_COORDS = "Latitude and Longitude";

        let skippedNoCoords = 0;
        let skippedBadCoords = 0;

        const byCoord = new Map();

        for (const r of rows) {
          const vin = String(r[COL_VIN] || '').trim();
          if (!vin) continue;

          const special = formatSpecial(r[COL_SPEC]);
          const servicedAt = String(r[COL_DEALER] || 'Service Location').trim();

          const coordsRaw = r[COL_COORDS];
          if (!coordsRaw || String(coordsRaw).trim() === '') {
            skippedNoCoords++;
            continue;
          }

          const [lat, lng] = parseCoords(coordsRaw);
          if (isNaN(lat) || isNaN(lng)) {
            skippedBadCoords++;
            continue;
          }

          const key = normalizeCoordKey(lat, lng);
          if (!byCoord.has(key)) byCoord.set(key, { lat, lng, servicedAt, items: [] });

          const bucket = byCoord.get(key);
          if (!bucket.servicedAt && servicedAt) bucket.servicedAt = servicedAt;

          bucket.items.push({ vin, special });
        }

        skippedNoCoordsEl.textContent = skippedNoCoords;
        skippedBadCoordsEl.textContent = skippedBadCoords;

        for (const [, bucket] of byCoord) {
          addLocationMarker(bucket.lat, bucket.lng, bucket.servicedAt || 'Service Location', bucket.items);
        }

        renderMarkers();
        if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
      }
    });

    searchInput.addEventListener('input', renderMarkers);
    document.getElementById('resetBtn').addEventListener('click', () => {
      searchInput.value = '';
      renderMarkers();
      if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
    });
  </script>
</body>
</html>
