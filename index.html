<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BMW Service Locations â€” Vehicles Map</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<style>
  html, body { height:100%; margin:0; }
  #map { height:100vh; width:100vw; }

  .controls{
    position:absolute; top:12px; left:12px; z-index:1000;
    background:#fff; padding:8px 10px; border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.15);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }

  .controls input{
    padding:6px 8px; border-radius:8px; border:1px solid #ddd;
    width:320px;
  }

  .legend{
    position:absolute; bottom:12px; left:12px; z-index:1000;
    background:#fff; padding:8px 10px; border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.15);
    font-size:13px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }

  .count{ font-weight:700; }
  .popup-title{ font-weight:800; margin-bottom:6px; }
  .pill{
    display:inline-block; font-size:11px; padding:2px 8px;
    border-radius:999px; border:1px solid #ddd; background:#fafafa;
    margin-left:6px;
  }
</style>
</head>

<body>
<div id="map"></div>

<div class="controls">
  <input id="search" placeholder="Search VIN / #12/67 / LHD / RHD">
</div>

<div class="legend">
  <div><span class="count" id="locCount">0</span> locations</div>
  <div><span class="count" id="vinCount">0</span> VIN rows</div>
  <div>File: <code>vehicles.csv</code></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/**************** CONFIG ****************/
const CSV_FILE = "vehicles.csv";

/**************** MAP ****************/
const map = L.map("map").setView([50, 10], 5);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18,
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

const layer = L.layerGroup().addTo(map);
const bounds = L.latLngBounds([]);
const markers = [];

const locCount = document.getElementById("locCount");
const vinCount = document.getElementById("vinCount");
const search = document.getElementById("search");

function parseCoords(v){
  if(!v) return [NaN, NaN];
  const s = String(v).replace(/[()]/g,"").trim();
  const p = s.split(",");
  return [parseFloat(p[0]), parseFloat(p[1])];
}

function formatSpecial(v){
  const m = String(v||"").match(/^#?(\d+)[- /]*(LHD|RHD)/i);
  if(!m) return v || "";
  return `#${m[1].padStart(2,"0")}/67 ${m[2].toUpperCase()}`;
}

Papa.parse(CSV_FILE, {
  download:true,
  header:true,
  skipEmptyLines:true,
  complete: res => {
    const rows = res.data || [];
    vinCount.textContent = rows.length;

    const fields = res.meta.fields || [];
    const colVIN = fields[2];   // Column C
    const colSpec = fields[3];  // Column D
    const colDealer = fields[8];// Column I
    const colCoords = fields[11];// Column L

    const byLoc = new Map();

    rows.forEach(r => {
      const vin = (r[colVIN] || "").trim();
      if(!vin) return;

      const spec = formatSpecial(r[colSpec]);
      const dealer = (r[colDealer] || "Service Location").trim();
      const [lat,lng] = parseCoords(r[colCoords]);
      if(isNaN(lat) || isNaN(lng)) return;

      const key = `${lat.toFixed(6)},${lng.toFixed(6)}`;
      if(!byLoc.has(key)){
        byLoc.set(key,{lat,lng,dealer,items:[]});
      }
      byLoc.get(key).items.push({vin,spec});
    });

    byLoc.forEach(loc => {
      const html = `
        <div class="popup-title">${loc.dealer}</div>
        ${loc.items.map(v =>
          `<div><code>${v.vin}</code>
          ${v.spec?`<span class="pill">${v.spec}</span>`:""}</div>`
        ).join("")}
      `;

      const m = L.circleMarker([loc.lat, loc.lng], {
        radius:6, fillOpacity:0.85
      }).bindPopup(html);

      m.search = loc.items.map(v=>`${v.vin} ${v.spec}`).join(" ").toLowerCase();
      markers.push(m);
      m.addTo(layer);
      bounds.extend([loc.lat, loc.lng]);
    });

    locCount.textContent = markers.length;
    if(bounds.isValid()) map.fitBounds(bounds.pad(0.2));
  }
});

search.addEventListener("input", ()=>{
  const f = search.value.toLowerCase();
  layer.clearLayers();
  markers.forEach(m=>{
    if(!f || m.search.includes(f)) m.addTo(layer);
  });
});
</script>
</body>
</html>
